<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SGHSS - Painel Básico</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f5f5f5;
    }
    .login-container {
      max-width: 400px;
      margin: 80px auto;
      padding: 2rem;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
    }
    .app-container {
      display: none;
      padding: 1.5rem;
    }
    .nav-link.active {
      font-weight: bold;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .small-label {
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>
  <!-- Tela de Login -->
  <div class="login-container" id="loginContainer">
    <h4 class="mb-3 text-center">SGHSS - Login</h4>
    <div class="alert alert-danger d-none" id="loginError"></div>
    <form id="loginForm">
      <div class="mb-3">
        <label for="email" class="form-label">E-mail</label>
        <input
          type="email"
          class="form-control"
          id="email"
          placeholder="admin@vidaplus.com.br"
          required
        />
      </div>
      <div class="mb-3">
        <label for="senha" class="form-label">Senha</label>
        <input
          type="password"
          class="form-control"
          id="senha"
          placeholder="Digite sua senha"
          required
        />
      </div>
      <button type="submit" class="btn btn-primary w-100">Entrar</button>
    </form>
  </div>

  <!-- Aplicação após login -->
  <div class="app-container" id="appContainer">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SGHSS</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-section="pacientesSection">Pacientes</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="profissionaisSection">Profissionais</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="agendamentosSection">Agendamentos</a>
            </li>
            <li class="nav-item" id="navLogsItem">
              <a class="nav-link" href="#" data-section="logsSection">Auditoria / Logs</a>
            </li>
          </ul>
          <span class="navbar-text me-3" id="userInfo"></span>
          <button class="btn btn-outline-light btn-sm" id="logoutBtn">Sair</button>
        </div>
      </div>
    </nav>

    <!-- Conteúdo -->
    <div class="container">
      <!-- Pacientes -->
      <div id="pacientesSection" class="section active">
        <h5>Pacientes</h5>
        <p class="text-muted small-label">CRUD básico de pacientes (lista + cadastro rápido).</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">Novo Paciente</div>
              <div class="card-body">
                <form id="formPaciente">
                  <div class="mb-2">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" id="pacienteNome" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">CPF</label>
                    <input type="text" class="form-control" id="pacienteCpf" placeholder="apenas números" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Data de Nascimento</label>
                    <input type="date" class="form-control" id="pacienteDataNasc" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Telefone</label>
                    <input type="text" class="form-control" id="pacienteTelefone" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="pacienteEmail" />
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="pacienteConsentimento" checked />
                    <label class="form-check-label" for="pacienteConsentimento">
                      Consentimento LGPD
                    </label>
                  </div>
                  <button type="submit" class="btn btn-success btn-sm">Salvar Paciente</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Lista de Pacientes</h6>
              <button class="btn btn-outline-primary btn-sm" id="btnCarregarPacientes">
                Atualizar lista
              </button>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm table-striped align-middle">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>E-mail</th>
                  </tr>
                </thead>
                <tbody id="pacientesTableBody">
                  <tr><td colspan="4" class="text-muted">Clique em "Atualizar lista".</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Profissionais -->
      <div id="profissionaisSection" class="section">
        <h5>Profissionais</h5>
        <p class="text-muted small-label">CRUD básico de profissionais de saúde.</p>

        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">Novo Profissional</div>
              <div class="card-body">
                <form id="formProfissional">
                  <div class="mb-2">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" id="profNome" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">CRM</label>
                    <input type="text" class="form-control" id="profCrm" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Especialidade</label>
                    <input type="text" class="form-control" id="profEspecialidade" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Telefone</label>
                    <input type="text" class="form-control" id="profTelefone" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="profEmail" />
                  </div>
                  <button type="submit" class="btn btn-success btn-sm">Salvar Profissional</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Lista de Profissionais</h6>
              <button class="btn btn-outline-primary btn-sm" id="btnCarregarProfissionais">
                Atualizar lista
              </button>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm table-striped align-middle">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>CRM</th>
                    <th>Especialidade</th>
                    <th>E-mail</th>
                  </tr>
                </thead>
                <tbody id="profissionaisTableBody">
                  <tr><td colspan="5" class="text-muted">Clique em "Atualizar lista".</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Agendamentos -->
      <div id="agendamentosSection" class="section">
        <h5>Agendamentos (Consultas)</h5>
        <p class="text-muted small-label">
          CRUD simplificado de agendamentos, vinculando paciente e profissional.
        </p>

        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">Novo Agendamento</div>
              <div class="card-body">
                <form id="formAgendamento">
                  <div class="mb-2">
                    <label class="form-label">ID do Paciente</label>
                    <input type="number" class="form-control" id="agPacienteId" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">ID do Profissional</label>
                    <input type="number" class="form-control" id="agProfissionalId" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Data e Horário</label>
                    <input
                      type="text"
                      class="form-control"
                      id="agDataHorario"
                      placeholder="ex: 10/12/2025 10:00:00"
                      required
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Duração (minutos)</label>
                    <input type="number" class="form-control" id="agDuracao" value="30" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label>
                    <input type="text" class="form-control" id="agTipo" placeholder="Consulta, Retorno..." />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Observações</label>
                    <textarea class="form-control" id="agObs" rows="2"></textarea>
                  </div>
                  <button type="submit" class="btn btn-success btn-sm">Salvar Agendamento</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Lista de Agendamentos</h6>
              <button class="btn btn-outline-primary btn-sm" id="btnCarregarAgendamentos">
                Atualizar lista
              </button>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm table-striped align-middle">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Paciente</th>
                    <th>Profissional</th>
                    <th>Data/Hora</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="agendamentosTableBody">
                  <tr><td colspan="5" class="text-muted">Clique em "Atualizar lista".</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Auditoria / Logs (somente ADMIN) -->
      <div id="logsSection" class="section">
        <h5>Auditoria / Logs</h5>
        <p class="text-muted small-label">
          Visualização dos registros de auditoria do sistema (apenas para usuários ADMIN).
        </p>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Logs recentes</h6>
          <button class="btn btn-outline-primary btn-sm" id="btnCarregarLogs">
            Atualizar logs
          </button>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuário</th>
                <th>Ação</th>
                <th>Entidade</th>
                <th>Registro</th>
                <th>Data/Hora</th>
              </tr>
            </thead>
            <tbody id="logsTableBody">
              <tr><td colspan="6" class="text-muted">Clique em "Atualizar logs".</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div> <!-- /container -->
  </div> <!-- /appContainer -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE_URL = 'http://localhost:3000';

    let authToken = null;
    let refreshToken = null;
    let currentUser = null;

    const loginContainer = document.getElementById('loginContainer');
    const appContainer = document.getElementById('appContainer');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const userInfoSpan = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');

    const navLinks = document.querySelectorAll('.nav-link[data-section]');
    const sections = document.querySelectorAll('.section');
    const navLogsItem = document.getElementById('navLogsItem');

    // Pacientes
    const formPaciente = document.getElementById('formPaciente');
    const btnCarregarPacientes = document.getElementById('btnCarregarPacientes');
    const pacientesTableBody = document.getElementById('pacientesTableBody');

    // Profissionais
    const formProfissional = document.getElementById('formProfissional');
    const btnCarregarProfissionais = document.getElementById('btnCarregarProfissionais');
    const profissionaisTableBody = document.getElementById('profissionaisTableBody');

    // Agendamentos
    const formAgendamento = document.getElementById('formAgendamento');
    const btnCarregarAgendamentos = document.getElementById('btnCarregarAgendamentos');
    const agendamentosTableBody = document.getElementById('agendamentosTableBody');

    // Logs
    const btnCarregarLogs = document.getElementById('btnCarregarLogs');
    const logsTableBody = document.getElementById('logsTableBody');

    // Utilitário: formata data no padrão brasileiro
    function formatarDataBR(dataISO) {
      if (!dataISO) return '-';
      const data = new Date(dataISO);
      if (isNaN(data.getTime())) return dataISO;
      return data.toLocaleString('pt-BR', { timeZone: 'UTC' });
    }

    // ------------------ AUTH / STORAGE ------------------

    function setSession(token, refresh, usuario) {
      authToken = token || null;
      refreshToken = refresh || null;
      currentUser = usuario || null;

      if (token && usuario) {
        localStorage.setItem('sghss_token', token);
        localStorage.setItem('sghss_user', JSON.stringify(usuario));
      } else {
        localStorage.removeItem('sghss_token');
        localStorage.removeItem('sghss_user');
      }

      if (refresh) {
        localStorage.setItem('sghss_refresh_token', refresh);
      } else {
        localStorage.removeItem('sghss_refresh_token');
      }
    }

    function loadSessionFromStorage() {
      const token = localStorage.getItem('sghss_token');
      const userStr = localStorage.getItem('sghss_user');
      const refresh = localStorage.getItem('sghss_refresh_token');

      if (token && userStr) {
        authToken = token;
        refreshToken = refresh || null;
        currentUser = JSON.parse(userStr);
        showApp();
      }
    }

    function showApp() {
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      if (currentUser) {
        userInfoSpan.textContent = currentUser.email + ' (' + currentUser.papel + ')';
      }

      // controlar visualização da aba de logs (somente ADMIN)
      if (!currentUser || currentUser.papel !== 'ADMIN') {
        navLogsItem.style.display = 'none';
        document.getElementById('logsSection').style.display = 'none';
      } else {
        navLogsItem.style.display = 'block';
      }
    }

    function showLogin() {
      appContainer.style.display = 'none';
      loginContainer.style.display = 'block';
      setSession(null, null, null);
    }

    // ------------------ NAVEGAÇÃO ------------------

    navLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const target = link.getAttribute('data-section');

        navLinks.forEach((l) => l.classList.remove('active'));
        sections.forEach((s) => s.classList.remove('active'));

        link.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    // ------------------ LOGIN ------------------

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('d-none');
      const email = document.getElementById('email').value.trim();
      const senha = document.getElementById('senha').value.trim();

      try {
        const res = await fetch(API_BASE_URL + '/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, senha })
        });

        if (!res.ok) {
          throw new Error('Credenciais inválidas ou erro no servidor.');
        }

        const data = await res.json();
        if (!data.token) {
          throw new Error('Resposta de login inválida.');
        }

        // agora também pegamos o refresh_token
        setSession(data.token, data.refresh_token || null, data.usuario);
        showApp();
      } catch (err) {
        loginError.textContent = err.message;
        loginError.classList.remove('d-none');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      showLogin();
    });

    // ------------------ REQUEST COM REFRESH AUTOMÁTICO ------------------

    async function requestWithAuth(method, path, bodyObj = null, retry = true) {
      const options = {
        method,
        headers: {
          'Authorization': authToken ? 'Bearer ' + authToken : ''
        }
      };

      if (bodyObj !== null) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(bodyObj);
      }

      const res = await fetch(API_BASE_URL + path, options);

      // se der 401 e tivermos refresh_token, tentar renovar
      if (res.status === 401 && retry && refreshToken) {
        const renovado = await tentarRenovarToken();
        if (renovado) {
          // tenta novamente uma única vez
          return requestWithAuth(method, path, bodyObj, false);
        } else {
          alert('Sua sessão expirou. Faça login novamente.');
          showLogin();
          throw new Error('Sessão expirada');
        }
      }

      if (!res.ok) {
        const text = await res.text();
        throw new Error('Erro na requisição: ' + res.status + ' - ' + text);
      }

      // pode haver respostas sem JSON
      const contentType = res.headers.get('Content-Type') || '';
      if (contentType.includes('application/json')) {
        return res.json();
      }
      return res.text();
    }

    async function tentarRenovarToken() {
      try {
        if (!refreshToken) return false;

        const res = await fetch(API_BASE_URL + '/auth/refresh', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ refresh_token: refreshToken })
        });

        if (!res.ok) {
          return false;
        }

        const data = await res.json();
        if (!data.token) {
          return false;
        }

        // mantém o usuário e refreshToken atual, só troca o access token
        setSession(data.token, refreshToken, currentUser);
        return true;
      } catch (err) {
        console.error('Erro ao renovar token:', err);
        return false;
      }
    }

    // Wrappers específicos
    async function apiGet(path) {
      return requestWithAuth('GET', path);
    }

    async function apiPost(path, bodyObj) {
      return requestWithAuth('POST', path, bodyObj);
    }

    async function apiPut(path, bodyObj) {
      return requestWithAuth('PUT', path, bodyObj);
    }

    async function apiPatch(path, bodyObj) {
      return requestWithAuth('PATCH', path, bodyObj);
    }

    async function apiDelete(path) {
      return requestWithAuth('DELETE', path);
    }

    // ------------------ PACIENTES ------------------

    async function carregarPacientes() {
      try {
        const pacientes = await apiGet('/pacientes');
        pacientesTableBody.innerHTML = '';
        if (!pacientes || pacientes.length === 0) {
          pacientesTableBody.innerHTML =
            '<tr><td colspan="5" class="text-muted">Nenhum paciente encontrado.</td></tr>';
          return;
        }
        pacientes.forEach((p) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.nome || '-'}</td>
            <td>${p.telefone || '-'}</td>
            <td>${p.email || '-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary me-1" data-action="paciente-edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-sm btn-outline-danger" data-action="paciente-delete" data-id="${p.id}">Desativar</button>
            </td>
          `;
          pacientesTableBody.appendChild(tr);
        });
      } catch (err) {
        alert(err.message);
      }
    }

    btnCarregarPacientes.addEventListener('click', carregarPacientes);

    formPaciente.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('pacienteNome').value.trim();
      const cpf = document.getElementById('pacienteCpf').value.trim();
      const data_nascimento = document.getElementById('pacienteDataNasc').value || null;
      const telefone = document.getElementById('pacienteTelefone').value.trim();
      const email = document.getElementById('pacienteEmail').value.trim();
      const consentimento_lgpd = document.getElementById('pacienteConsentimento').checked;

      const body = {
        nome,
        cpf,
        data_nascimento,
        telefone,
        email,
        endereco: null,
        consentimento_lgpd
      };

      try {
        await apiPost('/pacientes', body);
        alert('Paciente cadastrado com sucesso.');
        formPaciente.reset();
        document.getElementById('pacienteConsentimento').checked = true;
        carregarPacientes();
      } catch (err) {
        alert(err.message);
      }
    });

    pacientesTableBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === 'paciente-delete') {
        if (!confirm('Deseja realmente desativar este paciente?')) return;
        try {
          await apiDelete(`/pacientes/${id}`);
          alert('Paciente desativado com sucesso.');
          carregarPacientes();
        } catch (err) {
          alert(err.message);
        }
      }

      if (action === 'paciente-edit') {
        try {
          const paciente = await apiGet(`/pacientes/${id}`);
          const nome = prompt('Nome do paciente:', paciente.nome || '');
          if (nome === null) return;
          const telefone = prompt('Telefone:', paciente.telefone || '');
          if (telefone === null) return;
          const email = prompt('E-mail:', paciente.email || '');
          if (email === null) return;

          const body = { nome, telefone, email };
          await apiPut(`/pacientes/${id}`, body);
          alert('Paciente atualizado com sucesso.');
          carregarPacientes();
        } catch (err) {
          alert(err.message);
        }
      }
    });

    // ------------------ PROFISSIONAIS ------------------

    async function carregarProfissionais() {
      try {
        const profissionais = await apiGet('/profissionais');
        profissionaisTableBody.innerHTML = '';
        if (!profissionais || profissionais.length === 0) {
          profissionaisTableBody.innerHTML =
            '<tr><td colspan="6" class="text-muted">Nenhum profissional encontrado.</td></tr>';
          return;
        }
        profissionais.forEach((p) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.nome || '-'}</td>
            <td>${p.crm || '-'}</td>
            <td>${p.especialidade || '-'}</td>
            <td>${p.email || '-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary me-1" data-action="prof-edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-sm btn-outline-danger" data-action="prof-delete" data-id="${p.id}">Desativar</button>
            </td>
          `;
          profissionaisTableBody.appendChild(tr);
        });
      } catch (err) {
        alert(err.message);
      }
    }

    btnCarregarProfissionais.addEventListener('click', carregarProfissionais);

    formProfissional.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('profNome').value.trim();
      const crm = document.getElementById('profCrm').value.trim();
      const especialidade = document.getElementById('profEspecialidade').value.trim();
      const telefone = document.getElementById('profTelefone').value.trim();
      const email = document.getElementById('profEmail').value.trim();

      const body = {
        nome,
        crm,
        especialidade,
        telefone,
        email
      };

      try {
        await apiPost('/profissionais', body);
        alert('Profissional cadastrado com sucesso.');
        formProfissional.reset();
        carregarProfissionais();
      } catch (err) {
        alert(err.message);
      }
    });

    profissionaisTableBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === 'prof-delete') {
        if (!confirm('Deseja realmente desativar este profissional?')) return;
        try {
          await apiDelete(`/profissionais/${id}`);
          alert('Profissional desativado com sucesso.');
          carregarProfissionais();
        } catch (err) {
          alert(err.message);
        }
      }

      if (action === 'prof-edit') {
        try {
          const prof = await apiGet(`/profissionais/${id}`);
          const nome = prompt('Nome do profissional:', prof.nome || '');
          if (nome === null) return;
          const crm = prompt('CRM:', prof.crm || '');
          if (crm === null) return;
          const especialidade = prompt('Especialidade:', prof.especialidade || '');
          if (especialidade === null) return;
          const telefone = prompt('Telefone:', prof.telefone || '');
          if (telefone === null) return;
          const email = prompt('E-mail:', prof.email || '');
          if (email === null) return;

          const body = { nome, crm, especialidade, telefone, email };
          await apiPut(`/profissionais/${id}`, body);
          alert('Profissional atualizado com sucesso.');
          carregarProfissionais();
        } catch (err) {
          alert(err.message);
        }
      }
    });

    // ------------------ AGENDAMENTOS ------------------

    async function carregarAgendamentos() {
      try {
        const ags = await apiGet('/agendamentos');
        agendamentosTableBody.innerHTML = '';
        if (!ags || ags.length === 0) {
          agendamentosTableBody.innerHTML =
            '<tr><td colspan="6" class="text-muted">Nenhum agendamento encontrado.</td></tr>';
          return;
        }
        ags.forEach((a) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${a.id}</td>
            <td>${a.patient_id || a.paciente_id || '-'}</td>
            <td>${a.professional_id || a.profissional_id || '-'}</td>
            <td>${formatarDataBR(a.data_horario)}</td>
            <td>${a.status || '-'}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary me-1" data-action="ag-edit" data-id="${a.id}">Editar</button>
              <button class="btn btn-sm btn-outline-danger" data-action="ag-cancel" data-id="${a.id}">Cancelar</button>
            </td>
          `;
          agendamentosTableBody.appendChild(tr);
        });
      } catch (err) {
        alert(err.message);
      }
    }

    btnCarregarAgendamentos.addEventListener('click', carregarAgendamentos);

    formAgendamento.addEventListener('submit', async (e) => {
      e.preventDefault();
      const paciente_id = Number(document.getElementById('agPacienteId').value);
      const profissional_id = Number(document.getElementById('agProfissionalId').value);
      const data_horario = document.getElementById('agDataHorario').value.trim();
      const duracao_minutos = Number(document.getElementById('agDuracao').value || 30);
      const tipo = document.getElementById('agTipo').value.trim();
      const observacoes = document.getElementById('agObs').value.trim();

      const body = {
        paciente_id,
        profissional_id,
        data_horario,
        duracao_minutos,
        tipo,
        observacoes
      };

      try {
        await apiPost('/agendamentos', body);
        alert('Agendamento criado com sucesso.');
        formAgendamento.reset();
        document.getElementById('agDuracao').value = 30;
        carregarAgendamentos();
      } catch (err) {
        alert(err.message);
      }
    });

    agendamentosTableBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === 'ag-cancel') {
        if (!confirm('Deseja realmente cancelar este agendamento?')) return;
        try {
          await apiPatch(`/agendamentos/${id}/cancelar`);
          alert('Agendamento cancelado com sucesso.');
          carregarAgendamentos();
        } catch (err) {
          alert(err.message);
        }
      }

      if (action === 'ag-edit') {
        try {
          const ag = await apiGet(`/agendamentos/${id}`);
          const dataAtualBR = formatarDataBR(ag.data_horario);
          const novaData = prompt('Nova data/horário (DD/MM/AAAA HH:mm:ss):', dataAtualBR);
          if (novaData === null) return;
          const novaDuracao = prompt('Nova duração (minutos):', ag.duracao_minutos || 30);
          if (novaDuracao === null) return;
          const novoTipo = prompt('Tipo (Consulta, Retorno...):', ag.tipo || '');
          if (novoTipo === null) return;
          const novasObs = prompt('Observações:', ag.observacoes || '');
          if (novasObs === null) return;

          const body = {
            data_horario: novaData,
            duracao_minutos: Number(novaDuracao),
            tipo: novoTipo,
            observacoes: novasObs
          };

          await apiPatch(`/agendamentos/${id}/reagendar`, body);
          alert('Agendamento atualizado com sucesso.');
          carregarAgendamentos();
        } catch (err) {
          alert(err.message);
        }
      }
    });

    // ------------------ LOGS (AUDITORIA) ------------------

    async function carregarLogs() {
      try {
        const resposta = await apiGet('/auditLogs?pagina=1&limite=20');
        const registros = resposta.registros || resposta || [];
        logsTableBody.innerHTML = '';
        if (!registros || registros.length === 0) {
          logsTableBody.innerHTML =
            '<tr><td colspan="6" class="text-muted">Nenhum log encontrado.</td></tr>';
          return;
        }
        registros.forEach((log) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${log.id}</td>
            <td>${log.user_id || '-'}</td>
            <td>${log.acao || '-'}</td>
            <td>${log.entidade || '-'}</td>
            <td>${log.entidade_id || '-'}</td>
            <td>${formatarDataBR(log.criado_em)}</td>
          `;
          logsTableBody.appendChild(tr);
        });
      } catch (err) {
        alert(err.message);
      }
    }

    btnCarregarLogs.addEventListener('click', carregarLogs);

    // ------------------ INICIALIZAÇÃO ------------------

    loadSessionFromStorage();
  </script>

</body>
</html>
